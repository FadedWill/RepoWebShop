@model OrderDetailsViewModel

<link href="~/Content/Order/Detail.css" rel="stylesheet" />

@{
    var pickUp = Model.Order.PickUpTime?.ToString("dd'/'MM'/'yyyy") ?? string.Empty;
}

<div class="container order-detail">
    <h3>Detalles: @Model.Order.FriendlyBookingId</h3>

    <div class="container">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Cantidad</th>
                    <th>Producto</th>
                    <th>Precio</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td> @item.Amount </td>
                        <td> @item.Pie.PieDetail.Name @item.Pie.Name </td>
                        <td> @item.Pie.Price</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <br />

    <div>
        @if(!Model.Order.Finished && !Model.Order.Cancelled)
        {
            <a class="btn btn-info">Pedido terminado</a>    
        }

        @if(Model.Order.Finished && !Model.Order.Cancelled)
        {
            <a class="btn btn-success" onclick="invertPickedUpStatus()">Pedido retirado</a>
        }

        @if(!Model.Order.PickedUp && !Model.Order.Cancelled)
        {
            <a class="btn btn-warning" href="/Order/Cancel/@Model.Order.OrderId">Cancelar pedido</a>
        }
        
    </div>
    <div>
        @{ 
            var paymentState = Model.Order.OrderPaymentStatus.GetType();

            if(paymentState == typeof(OrderReservationNotPaid))
            {
                <a class="btn btn-success" onclick="payOrder()">Pago recibido</a>
            }

            if(paymentState == typeof(OrderReservationPaid) || paymentState == typeof(OrderMercadoPagoPaid))
            {
                <a class="btn btn-danger" onclick="refundOrder()">Devolver dinero</a>
            }
        }
    </div>

    <br />
    <table class="table table-user-information" >
        <tbody>
            <tr>
                <td><strong>Estado</strong></td>
                @{var cancelled = Model.Order.Cancelled ? "<div class='text-muted'>Pedido cancelado</div>" : "";}
                <td colspan="2" id="">@Model.Order.StatusSpanish @Html.Raw(cancelled)</td>
            </tr>
            <tr>
                <td><strong>Total</strong></td>
                <td colspan="2">@Model.Order.OrderTotal</td>
            </tr>
            <tr>
                <td><strong>Cliente</strong></td>
                <td colspan="2" id="">
                    @Html.Raw(Model.Order.ContactDataAsHtml)

                </td>
            </tr>
            @if (Model.Order.Status == "reservation")
    {
        <tr>
            <td><strong>Pago</strong></td>
            @{var paidInStore = Model.Order.PaymentReceived ? "Pago recibido en sucursal" : "Pago sin recibir"; }
            <td colspan="2" onclick="paymentInStore()">@paidInStore</td>
        </tr>
}

            <tr>
                <td><strong>Comentarios</strong></td>
                <td colspan="2">@Model.Order.CustomerComments</td>
            </tr>
            <tr>
                <td><strong>Fecha Creacion</strong></td>
                <td colspan="2">@Model.Order.OrderPlaced.ToShortDateString() @Model.Order.OrderPlaced.ToShortTimeString() </td>
            </tr>
            <tr>
                <td><strong>Plazo</strong></td>
                <td colspan="2">@Model.Order.PreparationTime hs.</td>
            </tr>
            <tr>
                <td><strong>Correo enviado</strong></td>
                <td colspan="2">
                    <div>
                        <p><strong>@Model.Order.Email?.To</strong> <a href="/Order/EmailNotification/@Model.Order.OrderId" target="_blank">Ver</a></p>
                    </div>
                </td>
            </tr>
            <tr>
                <td><strong>Registro</strong></td>
                <td colspan="2">
                    <div>
                        @Model.Order.OrderHistory
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="alert alert-success" id="successMessage" style="">
        Cambio guardado satisfactoriamente!
    </div>
    <div class="alert alert-danger" id="errorMessage" style="">
        Ocurrio un error al guardar. Intente mas tarde.
    </div>
</div>
<script type="text/javascript">
$.fn.datepicker.defaults.format = "dd/mm/yyyy";
$('.datepicker').datepicker();

function addComments(comments) {
    $.ajax({
        type: 'POST',
        data: {},
        url: '/api/OrderData/AddComments/' + '@Model.Order.OrderId' + '/' + comments,
        success: function () {
            handleSuccess();
        },
        error: function () {
            handleError();
        }
    });
}

function payOrder() {
    $.ajax({
        type: 'POST',
        data: {},
        url: '/api/OrderData/PayOrder/@Model.Order.OrderId',
        success: function () {
            window.location.reload();
        },
        error: function () {
            handleError();
        }
    });
}

function refundOrder() {
    $.ajax({
        type: 'POST',
        data: {'test':'123'},
        url: '/api/OrderData/RefundOrder/@Model.Order.OrderId',
        success: function () {
            window.location.reload();
        },
        error: function () {
            handleError();
        }
    });
}

function invertPickedUpStatus() {
    $.ajax({
        type: 'POST',
        data: {},
        url: '/api/OrderData/InvertPickedUpStatus/' + '@Model.Order.OrderId',
        success: function () {
            window.location.reload();
        },
        error: function () {
            handleError();
        }
    });
}


$("#pickUpSubmit").on('click', function () {
    var parts = $("#pickUpDateSubmit").val().split("/");
    var date = new Date(parts[2], parts[1] - 1, parts[0]);

    $.ajax({
        type: 'POST',
        data: {},
        url: '/api/OrderData/UpdatePickUpDate/@Model.Order.OrderId/' + date,
        success: function () {
            handleSuccess();
        },
        error: function () {
            handleError();
        }
    });
})

function handleSuccess() {
    $('#successMessage').fadeIn(1000).fadeOut(2000);
}
function handleError() {
    $('#errorMessage').css("display", "flex");
}
</script>

