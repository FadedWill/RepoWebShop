@model OrderDetailsViewModel

<link href="~/Content/Order/Detail.css" rel="stylesheet" />

@{
    var pickUp = Model.Order.PickUp?.ToString("dd'/'MM'/'yyyy") ?? string.Empty;
}

<div class="container">
    <h3>Detalles: @Model.Order.FriendlyBookingId</h3>

    <div class="container">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Cantidad</th>
                    <th>Producto</th>
                    <th>Precio</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Items)
                {
                    <tr>
                        <td> @item.Amount </td>
                        <td> @item.Pie.PieDetail.Name @item.Pie.Name </td>
                        <td> @item.Pie.Price</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <br />
    <table class="table table-user-information" >
        <tbody>
            <tr>
                <td><strong>Estado</strong></td>
                <td colspan="2" id="orderStatus"></td>
            </tr>
            <tr>
                <td><strong>Total</strong></td>
                <td colspan="2">@Model.Order.OrderTotal</td>
            </tr>
            <tr>
                <td><strong>Cliente</strong></td>
                <td colspan="2" id="contactDetails"></td>
            </tr>
            <tr>
                <td><strong>Comentarios</strong></td>
                <td colspan="2">@Model.Order.CustomerComments</td>
            </tr>
            <tr>
                <td><strong>Fecha Creacion</strong></td>
                <td colspan="2">@Model.Order.OrderPlaced.ToShortDateString() @Model.Order.OrderPlaced.ToShortTimeString() </td>
            </tr>
            <tr>
                <td><strong>Plazo</strong></td>
                <td colspan="2">@Model.Order.PreparationTime</td>
            </tr>
            <tr>
                <td><strong>Entrega Pautada</strong></td>
                <td>
                    <label>@Model.Order.PickUp.ToString()</label>
                    <div class="input-group date" data-provide="datepicker">
                        <input id="pickUpDateSubmit" type="text" class="form-control" value="@pickUp">
                        <div class="input-group-addon">
                            <span class="glyphicon glyphicon-th"></span>
                        </div>
                    </div>
                    <span style="display:none;" id="dateSaveMessage"></span>
                </td>
                <td>
                    <input id="pickUpSubmit" type="submit" class="btn btn-primary" value="Guardar" />
                </td>
            </tr>
            <tr>
                <td><strong>Entregado</strong></td>
                <td>
                    <div id="pickedUpStatus">@(@Model.Order.PickedUp ? "Si" : "No")</div>
                    <span style="display:none;" id="pickedUpChanged"></span>
                </td>
                <td>
                    <input type="submit" class="btn btn-primary" value="Cambiar" id="pickedUp" />
                </td>
            </tr>
            <tr>
                <td><strong>Comentarios Agregados</strong></td>
                <td>
                    <textarea id="comments">@Model.Order.ManagementComments</textarea>
                    <span style="display:none;" id="commentsChanged"></span>
                </td>
                <td>
                    <input id="commentsSubmit" type="submit" class="btn btn-primary" value="Guardar" />
                </td>
            </tr>
            <tr>
                <td><strong>Correo enviado</strong></td>
                <td colspan="2">
                    <div>
                        <p><strong>@Model.Order.Email.To</strong></p>
                        <p>@Html.Raw(Model.Order.Email.Body)</p>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="alert alert-success" id="successMessage" style="display:none;">
        Cambio guardado satisfactoriamente!
    </div>
    <div class="alert alert-danger" id="errorMessage" style="display:none;">
        Ocurrio un error al guardar. Intente mas tarde.
    </div>
</div>
<script type="text/javascript" >
    $.fn.datepicker.defaults.format = "dd/mm/yyyy";
$('.datepicker').datepicker();

$('#orderStatus').append(statusCode2DisplayValue('@Model.Order.Status'));

$('#contactDetails').append(getContactDetails());

function getContactDetails() {
    return '<p>@Model.Order.Registration?.LastName, @Model.Order.Registration?.FirstName <p/>' +
    '<p><a href="mailto:@Model.Order.Registration?.NormalizedEmail">@Model.Order.Registration?.NormalizedEmail.ToLower()</a> </p>' +
    '<p>@Model.Order.MercadoPagoName </p>' +
    '<p>@Model.Order.MercadoPagoUsername </p>' +
    '<p><a href="mailto:@Model.Order.MercadoPagoMail">@Model.Order.MercadoPagoMail</a></p>' +
    '<p><a href="tel:@Model.Order.PhoneNumber">@Model.Order.PhoneNumber</a></p>';
}


$("#commentsSubmit").on('click', function () {
    $.ajax({
        type: 'GET',
        url: '/api/OrderData/AddComments/' + '@Model.Order.OrderId' + '/' + $("#comments").val(),
        success: function () {
            handleSuccess('#commentsChanged');
        },
        error: function () {
            handleError('#commentsChanged');
        }
    });
});

$("#pickedUp").on('click', function () {
    $.ajax({
        type: 'GET',
        url: '/api/OrderData/InvertPickedUpStatus/' + '@Model.Order.OrderId',
        success: function (data) {
            $('#pickedUpStatus').empty().append(data ? 'Si' : 'No');
            handleSuccess('#pickedUpChanged');
        },
        error: function () {
            handleError('#pickedUpChanged');
        }
    });
});


$("#pickUpSubmit").on('click', function () {
    var parts = $("#pickUpDateSubmit").val().split("/");
    var date = new Date(parts[2], parts[1] - 1, parts[0]);

    $.ajax({
        type: 'GET',
        url: '/api/OrderData/UpdatePickUpDate/' + '@Model.Order.OrderId' + '/' + date.toUTCString(),
        success: function () {
            handleSuccess('#dateSaveMessage');
        },
        error: function () {
            handleError('#dateSaveMessage');
        }
    });
});

function handleSuccess(controller) {
    $(controller).empty().append('Guardado!').css("display", "flex").fadeOut(1000);
}
function handleError() {
    $(controller).empty().append('Ocurrio un error!').css("display", "flex");
}
</script>

